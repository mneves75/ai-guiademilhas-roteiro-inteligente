---
phase: 02-database-schema
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/db/seed.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Developer can run one command to populate database with sample data"
    - "Seed data is deterministic and idempotent (can run multiple times)"
    - "Sample data includes users, workspaces, subscriptions, and relationships"
    - "Database schema scripts are available for push, generate, migrate, seed, reset"
    - "Type inference works on seeded data"
  artifacts:
    - path: "src/db/seed.ts"
      provides: "Development database seeding script"
      exports: ["runSeed function", "sample data generation"]
    - path: "package.json"
      provides: "npm scripts for database operations"
      scripts: ["db:push", "db:generate", "db:migrate", "db:seed", "db:studio", "db:reset"]
  key_links:
    - from: "src/db/seed.ts"
      to: "src/db/schema.ts"
      via: "import schema tables"
      pattern: "import { users, workspaces } from '@/db/schema'"
    - from: "package.json scripts"
      to: "drizzle-kit"
      via: "drizzle-kit commands"
      pattern: "drizzle-kit push|generate|migrate"
---

<objective>
Create seed script for populating development database with realistic sample data, and add npm scripts for all database operations.

Purpose: Developers need to populate local database quickly for testing. Seed script provides 10 users, 5 workspaces, subscriptions, and relationships. npm scripts make database tasks fast and discoverable.

Output:
- src/db/seed.ts with deterministic sample data generation
- 6 npm scripts: db:push, db:generate, db:migrate, db:seed, db:studio, db:reset
- Fast local development setup (1 command to seed)
</objective>

<execution_context>
@/Users/mneves/.claude/get-shit-done/workflows/execute-plan.md
@.planning/phases/02-database-schema/02-02-SUMMARY.md
</execution_context>

<context>
@.planning/phases/02-database-schema/02-RESEARCH.md

Key patterns from RESEARCH.md:
- drizzle-seed: Deterministic faker for realistic test data
- Seed idempotency: Can run multiple times, same result
- Relations support: Seed understands workspace ‚Üí members ‚Üí subscriptions
- npm scripts: db:push (dev), db:generate (production), db:migrate (prod apply)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/db/seed.ts with sample data generation</name>
  <files>src/db/seed.ts</files>
  <action>
Create seeding script that generates realistic test data. Uses drizzle-seed for deterministic, reproducible data.

File: `src/db/seed.ts`

```typescript
import { drizzle } from "drizzle-orm/postgres-js";
import { seed } from "drizzle-seed";
import postgres from "postgres";
import * as schema from "./schema";

/**
 * Seed development database with sample data
 *
 * Generates:
 * - 10 users with realistic names/emails
 * - 5 workspaces (each owned by a user)
 * - Workspace members (users assigned to workspaces)
 * - 10 subscriptions (workspace billing records)
 *
 * Idempotent: Safe to run multiple times (overwrites with same data)
 * Deterministic: Same seed value = same data every time
 */
async function runSeed() {
  const client = postgres(process.env.DATABASE_URL!);
  const db = drizzle(client, { schema });

  console.log("üå± Seeding database...");

  try {
    await seed(db, schema).refine((funcs) => ({
      // ==================== USERS ====================
      // Create 10 realistic users with email addresses
      // drizzle-seed generates deterministic fake data
      users: funcs.users(
        {
          count: 10,
          columns: {
            name: funcs.firstName(), // "John", "Jane", etc.
            email: funcs.email(), // "john@example.com"
            emailVerified: true, // All verified in dev
            image: null, // No avatars in seed
          },
        },
        { isOneToOne: true }
      ),

      // ==================== WORKSPACES ====================
      // Create 5 workspaces, each owned by a different user
      workspaces: funcs.workspaces(
        {
          count: 5,
          columns: {
            name: funcs.companyName(), // "Acme Corp", "TechStart Inc", etc.
            slug: funcs.companyName()
              .then((name: string) => name.toLowerCase().replace(/\s+/g, "-")), // URL-safe slug
            ownerUserId: funcs.refOne({ ref: schema.users.id }), // Reference a user
          },
        },
        { isOneToOne: true }
      ),

      // ==================== WORKSPACE MEMBERS ====================
      // Assign users to workspaces (many-to-many relationship)
      // Creates team members across workspaces
      workspaceMembers: funcs.workspaceMembers({
        count: 15,
        columns: {
          workspaceId: funcs.refOne({ ref: schema.workspaces.id }),
          userId: funcs.refOne({ ref: schema.users.id }),
          role: funcs.pickOne(["owner", "member", "viewer"]), // Random role
        },
      }),

      // ==================== SUBSCRIPTIONS ====================
      // Create billing records for each workspace
      // Status mix: some active, some canceled
      subscriptions: funcs.subscriptions({
        count: 10,
        columns: {
          workspaceId: funcs.refOne({ ref: schema.workspaces.id }),
          stripeCustomerId: funcs.uuid(),
          stripeSubscriptionId: funcs.uuid(),
          stripePriceId: funcs.pickOne(["price_basic", "price_pro", "price_enterprise"]),
          status: funcs.pickOne(["active", "canceled", "past_due"]),
          currentPeriodStart: funcs.dateTime(),
          currentPeriodEnd: funcs.dateTime(),
          cancelAtPeriodEnd: funcs.boolean(),
        },
      }),
    })).execute();

    console.log("‚úì Database seeded successfully");
    console.log("  - 10 users");
    console.log("  - 5 workspaces");
    console.log("  - 15 workspace members");
    console.log("  - 10 subscriptions");
    console.log("\\nüí° Next steps:");
    console.log("  - Run: pnpm drizzle-kit studio (view data)");
    console.log("  - Query database in your app");
    console.log("\\n‚ö†Ô∏è  Seed data is for development only");
    console.log("  - Do NOT use in production");
    console.log("  - Delete .env.local and run pnpm db:reset to start over");

    process.exit(0);
  } catch (error) {
    console.error("‚úó Seed failed:", error);
    process.exit(1);
  }
}

runSeed().catch(console.error);
```

Why drizzle-seed:
- Deterministic: Same seed = same data every run
- Idempotent: Safe to run multiple times
- Realistic: Faker generates names, emails, slugs
- Relational: Understands foreign keys (users ‚Üí workspaces)
- TypeScript: Full type safety

Sample data generated:
- 10 users: Realistic names and emails
- 5 workspaces: Company names, URL-safe slugs
- 15 members: Users assigned to workspaces with roles
- 10 subscriptions: Workspace billing with Stripe references
- Mix of statuses: Some active, some canceled

Important:
- All users emailVerified=true (dev convenience)
- No actual Stripe IDs (UUIDs used for testing)
- Data regenerates on each run (idempotent)
- Safe to run multiple times (overwrites with same data)
  </action>
  <verify>
```bash
# File exists
ls src/db/seed.ts

# Check TypeScript
pnpm tsc src/db/seed.ts --noEmit
# Expected: No errors
```
  </verify>
  <done>
src/db/seed.ts created. Generates 10 users, 5 workspaces, 15 members, 10 subscriptions deterministically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add database npm scripts to package.json</name>
  <files>package.json</files>
  <action>
Add 6 npm scripts for database operations. Makes database tasks fast and discoverable.

Update `package.json` scripts section:

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint . --max-warnings=0",
    "lint:fix": "eslint . --fix",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "type-check": "tsc --noEmit",
    "prepare": "husky",

    // ===== DATABASE SCRIPTS =====

    /**
     * db:push
     * Fast schema sync for development (NO migration history)
     * Use: When schema changes locally
     * Speed: <5 seconds
     */
    "db:push": "drizzle-kit push",

    /**
     * db:generate
     * Generate SQL migration files from schema changes (for production)
     * Use: Before committing schema changes
     * Creates: src/db/migrations/*.sql
     * Always commit generated SQL files to git
     */
    "db:generate": "drizzle-kit generate",

    /**
     * db:migrate
     * Apply generated migrations to database
     * Use: In production deployments or after pulling generated migrations
     * Requires: Migration files to exist
     */
    "db:migrate": "drizzle-kit migrate",

    /**
     * db:seed
     * Populate database with development sample data
     * Use: After first db:push or to reset to clean state
     * Generates: 10 users, 5 workspaces, 15 members, 10 subscriptions
     * Idempotent: Safe to run multiple times
     * Note: Uses tsx to run TypeScript directly
     */
    "db:seed": "tsx ./src/db/seed.ts",

    /**
     * db:studio
     * Launch Drizzle Studio (visual database explorer)
     * Use: When you want to inspect/edit data visually
     * Opens: http://localhost:5173 by default
     * No browser required: CLI-based UI
     */
    "db:studio": "drizzle-kit studio",

    /**
     * db:reset
     * DANGEROUS: Delete all data and regenerate from seed
     * Use: When you want clean slate
     * Steps:
     *   1. Drop all tables (hard delete - no recovery!)
     *   2. Regenerate from schema
     *   3. Seed sample data
     * Do NOT use in production
     */
    "db:reset": "drizzle-kit drop && drizzle-kit push && tsx ./src/db/seed.ts"
  }
}
```

Script workflow:

**FIRST TIME SETUP:**
```bash
pnpm db:push     # Create tables (syncs schema)
pnpm db:seed     # Populate with sample data
pnpm db:studio   # Inspect data (optional)
```

**DAILY DEVELOPMENT:**
```bash
# Make schema change in src/db/schema.ts
pnpm db:push     # Apply change instantly
# Continue developing

# OR for production-like workflow:
pnpm db:generate # Creates SQL migration
pnpm db:migrate  # Apply migration
```

**RESET DATABASE:**
```bash
pnpm db:reset    # Delete everything + regenerate + seed
```

**INSPECT DATA:**
```bash
pnpm db:studio   # Visual database explorer
```

Why these specific scripts:
- db:push: Development only (fast, no history)
- db:generate: Production only (git-tracked SQL)
- db:migrate: Apply migrations (reproducible)
- db:seed: Sample data (idempotent)
- db:studio: Visual inspection (debugging)
- db:reset: Clean slate (destructive, dev only)

Important notes:
- Do NOT use db:push in production (no rollback history)
- Always use db:generate + db:migrate for production
- db:reset is DESTRUCTIVE (hard delete, no recovery)
- db:seed is safe to run multiple times
- tsx runs TypeScript files directly (no compilation step)

For production deployments:
```typescript
// In your deployment hook (Phase 12):
import { migrate } from "drizzle-orm/postgres-js/migrator";
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";

const client = postgres(process.env.DATABASE_URL!);
const db = drizzle(client);
await migrate(db, { migrationsFolder: "./src/db/migrations" });
```
  </action>
  <verify>
```bash
# Check package.json syntax
pnpm list 2>&1 | head -5
# Expected: No syntax errors

# Verify script names
grep -E "db:(push|generate|migrate|seed|studio|reset)" package.json
# Expected: All 6 scripts found
```
  </verify>
  <done>
package.json updated with 6 database scripts. All scripts callable via pnpm db:COMMAND.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install tsx for running TypeScript seed script</name>
  <files>package.json</files>
  <action>
Add tsx as dev dependency (needed to run src/db/seed.ts directly).

Command:
```bash
pnpm add -D tsx
```

Why tsx:
- Runs TypeScript files without compilation step
- Used for: pnpm db:seed (runs tsx ./src/db/seed.ts)
- Fast: In-memory transpilation
- Better than ts-node: Better caching, simpler config

What gets added:
- tsx package installed
- package.json devDependencies updated
- pnpm db:seed now works (executes tsx)
  </action>
  <verify>
```bash
# Verify installation
pnpm list tsx
# Expected: tsx@latest installed

# Test that tsx works
pnpm tsx --version
# Expected: Version output
```
  </verify>
  <done>
tsx installed as dev dependency. pnpm db:seed now executable.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. src/db/seed.ts exists and generates sample data
2. 6 database scripts added to package.json
3. Scripts are callable: pnpm db:push, pnpm db:seed, etc.
4. tsx installed (required for db:seed)
5. Sample data generation is deterministic and idempotent
6. No TypeScript errors in seed.ts
</verification>

<success_criteria>
- src/db/seed.ts generates realistic sample data (users, workspaces, members, subscriptions)
- 6 npm scripts available: db:push, db:generate, db:migrate, db:seed, db:studio, db:reset
- Each script has clear documentation (comments in package.json)
- pnpm db:seed can run multiple times with same results
- tsx installed (required dependency)
- First-time setup flow: pnpm db:push && pnpm db:seed
- Reset flow: pnpm db:reset (destructive, dev only)
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-schema/02-04-SUMMARY.md` with:
- Seed script created
- Sample data counts (10 users, 5 workspaces, etc.)
- 6 npm scripts added
- First-time setup instructions
- Ready for Phase 02-05 (verification checkpoint)
</output>
