---
phase: 03-authentication-core
plan: 03
type: execute
wave: 2
depends_on: [03-02]
files_modified:
  - .env.example
  - src/db/schema/postgres.ts
  - src/db/schema/sqlite.ts
  - src/db/queries/users.ts
  - src/lib/messages.ts
  - src/lib/auth/error-utils.ts
  - src/lib/security/prod-config.ts
  - src/components/landing/tech-stack.tsx
  - e2e/protected.e2e.ts
  - playwright.config.ts
  - README.md
  - PRODUCTION_CHECKLIST.md
  - SECURITY.md
  - ENGINEERING_SIGNOFF.md
  - docs/API.md
  - src/lib/__tests__/auth-routes.vitest.ts
autonomous: true
requirements: [AUTH-05, AUTH-06]

must_haves:
  truths:
    - "No source file references 'Better Auth' as the current auth system"
    - ".env.example documents Supabase Auth env vars instead of Better Auth"
    - "Regression tests verify the 3 new API routes return expected responses"
  artifacts:
    - path: ".env.example"
      provides: "Correct Supabase Auth env var documentation"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
    - path: "src/lib/__tests__/auth-routes.vitest.ts"
      provides: "Unit tests for password reset and magic link routes"
  key_links:
    - from: "src/lib/__tests__/auth-routes.vitest.ts"
      to: "app/api/auth/request-password-reset/route.ts"
      via: "import POST handler"
      pattern: "request-password-reset"
    - from: "src/lib/__tests__/auth-routes.vitest.ts"
      to: "app/api/auth/sign-in/magic-link/route.ts"
      via: "import POST handler"
      pattern: "magic-link"
---

<objective>
Clean up all stale Better Auth references across the codebase (source files, config, docs) and add regression tests for the 3 new API routes created in Plan 02.

Purpose: Eliminate developer confusion from outdated auth references. Ensure the new routes have test coverage so regressions are caught early.
Output: Updated source files with correct Supabase Auth references + new test file.
</objective>

<execution_context>
@/Users/mneves/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mneves/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-core/03-RESEARCH.md
@.planning/phases/03-authentication-core/03-02-SUMMARY.md

@.env.example
@src/db/schema/postgres.ts
@src/lib/messages.ts
@src/components/landing/tech-stack.tsx
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace stale Better Auth references in source files</name>
  <files>
    .env.example
    src/db/schema/postgres.ts
    src/db/schema/sqlite.ts
    src/db/queries/users.ts
    src/lib/messages.ts
    src/lib/auth/error-utils.ts
    src/lib/security/prod-config.ts
    src/components/landing/tech-stack.tsx
    e2e/protected.e2e.ts
    playwright.config.ts
  </files>
  <action>
Update each file to replace stale "Better Auth" references with accurate Supabase Auth references. Read each file first, then make targeted edits.

**1. `.env.example`** (lines 40-47):
Replace the entire "Authentication (Better Auth)" section:
```
# =============================================================================
# Authentication (Supabase Auth)
# =============================================================================
# Get from: https://supabase.com/dashboard → Settings → API
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```
Remove `BETTER_AUTH_SECRET`, `BETTER_AUTH_BASE_URL`, `BETTER_AUTH_URL` entirely.
Also update the Database section comment from "Neon recommended" to "Supabase recommended" since the project uses Supabase.

**2. `src/db/schema/postgres.ts`**:
- Line 31: Change `Managed by Better Auth (signup, OAuth, password reset)` to `App-level user profiles. Supabase Auth manages auth.users separately; this table is kept for FK relations.`
- Line 41: Change `Better Auth admin plugin fields` to `Admin plugin fields (role, banned status)`
- Line 54: Change `Browser session tokens (Better Auth handles creation)` to `Browser session tokens (legacy table, retained for FK compatibility)`
- Line 67: Change `Better Auth admin plugin field (tracks impersonator user id)` to `Admin impersonation field (tracks impersonator user id)`

**3. `src/db/schema/sqlite.ts`**:
- Line 23: Change `// ==================== BETTER AUTH TABLES ====================` to `// ==================== AUTH TABLES ====================`
- Line 33: Change `Better Auth admin plugin fields` to `Admin plugin fields (role, banned status)`
- Line 55: Change `Better Auth admin plugin field (tracks impersonator user id)` to `Admin impersonation field (tracks impersonator user id)`

**4. `src/db/queries/users.ts`** (line 6):
Change `Note: Better Auth tables don't use soft deletes` to `Note: User records don't use soft deletes (Supabase Auth manages user lifecycle)`

**5. `src/lib/messages.ts`**:
- Line 133 (English): Change `'Better Auth with email/password, OAuth, and magic links out of the box.'` to `'Authentication with email/password, OAuth, and magic links out of the box.'`
- Line 1021 (Portuguese): Change `'Better Auth com email/senha, OAuth e links mágicos.'` to `'Autenticação com email/senha, OAuth e links mágicos.'`

**6. `src/lib/auth/error-utils.ts`** (line 10):
Change `Better Auth (and some validation layers) may return compact messages like:` to `Supabase Auth (and some validation layers) may return compact messages like:`

**7. `src/lib/security/prod-config.ts`** (line 21):
Change `e.g. Better Auth baseURL` to `e.g. Supabase Auth, OAuth callbacks`

**8. `src/components/landing/tech-stack.tsx`** (line 11):
Change `'Better Auth'` to `'Supabase Auth'` in the technologies array.

**9. `e2e/protected.e2e.ts`** (line 53):
Change `name: 'better-auth.session_token'` to `name: 'sb-test-auth-token'` (or whichever Supabase cookie pattern matches the test setup). Check what the E2E test actually needs -- if it's checking that a specific cookie does NOT exist (to verify logged-out state), update to the Supabase cookie pattern `sb-` prefix.

**10. `playwright.config.ts`** (lines 45-50):
Remove the Better Auth env var defaults:
```typescript
// DELETE these lines:
// env.BETTER_AUTH_BASE_URL ||= env.BETTER_AUTH_URL || baseURL;
// env.BETTER_AUTH_URL ||= env.BETTER_AUTH_BASE_URL;
// env.BETTER_AUTH_SECRET ||= 'e2e-secret-please-override-this-in-prod-32chars';
```
Replace the comment on line 45 from `Production start requires an explicit canonical origin for Better Auth.` to `Production start requires an explicit canonical origin for auth callbacks.`
Add Supabase env var defaults if not already present:
```typescript
env.NEXT_PUBLIC_SUPABASE_URL ||= 'http://127.0.0.1:54321';
env.NEXT_PUBLIC_SUPABASE_ANON_KEY ||= 'test-anon-key';
```

**IMPORTANT:** Only modify the specific lines/sections listed. Do not restructure files or change unrelated code. Read each file fully before editing to understand surrounding context.

**DO NOT touch** `.planning/` docs, `CHANGELOG.md`, `progress.md`, `.env.local`, `.env.local.bak`, or `LEARN_CODEBASE.md` -- those are historical records or local files.
  </action>
  <verify>
Run `pnpm type-check` and `pnpm lint` to confirm no regressions. Grep for "Better Auth" in source files (excluding `.planning/`, `CHANGELOG.md`, `progress.md`, `LEARN_CODEBASE.md`, `docs/REVISAO_GERAL`, `docs/solucao-elegante`, `docs/seo-estrategia`, `relatorio_seguranca`, `.env.local*`) to confirm cleanup is complete.
  </verify>
  <done>All stale Better Auth references in active source/config files replaced with Supabase Auth. Type-check and lint pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update documentation files and add regression tests for auth routes</name>
  <files>
    README.md
    PRODUCTION_CHECKLIST.md
    SECURITY.md
    ENGINEERING_SIGNOFF.md
    docs/API.md
    src/lib/__tests__/auth-routes.vitest.ts
  </files>
  <action>
**Documentation updates** -- Read each file first, then make targeted edits:

**1. `README.md`**:
- Line 8: Change `**Better Auth** - Email/password, OAuth (Google/GitHub), password reset, magic link` to `**Supabase Auth** - Email/password, OAuth (Google/GitHub), password reset, magic link`
- Line 56: Change `| Auth       | Better Auth                  |` to `| Auth       | Supabase Auth (via @supabase/ssr)  |`

**2. `PRODUCTION_CHECKLIST.md`** (line 6):
Change `Set a strong \`BETTER_AUTH_SECRET\` (32+ chars, randomly generated).` to `Set \`NEXT_PUBLIC_SUPABASE_URL\` and \`NEXT_PUBLIC_SUPABASE_ANON_KEY\` from Supabase Dashboard.`

**3. `SECURITY.md`** (line 42):
Change `Use strong, unique values for \`BETTER_AUTH_SECRET\`` to `Set \`NEXT_PUBLIC_SUPABASE_URL\` and \`NEXT_PUBLIC_SUPABASE_ANON_KEY\` from Supabase Dashboard (anon key is safe for client exposure).`

**4. `ENGINEERING_SIGNOFF.md`** (lines 17-18 and 24-25):
Replace `BETTER_AUTH_SECRET=devsecretdevsecretdevsecretdevsecret` and `BETTER_AUTH_URL=http://localhost:3000` with:
```
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321 \
NEXT_PUBLIC_SUPABASE_ANON_KEY=test-anon-key \
```
(Keep the same formatting pattern as surrounding lines)

**5. `docs/API.md`** (lines 30, 34):
- Line 30: Change `## Auth (Better Auth)` to `## Auth (Supabase Auth)`
- Line 34: Change `Obs.: endpoints e payloads dependem da configuracao do Better Auth em \`src/lib/auth.ts\`.` to `Obs.: endpoints e payloads usam Supabase Auth via \`@supabase/ssr\`. Config em \`src/lib/supabase/server.ts\`.`

**Regression tests** -- Create `src/lib/__tests__/auth-routes.vitest.ts`:

Write unit tests that verify the 3 new API route handlers. Use Vitest mocking to mock `createSupabaseServerClient`. The tests should:

1. **request-password-reset route**:
   - Test: valid email returns 200 with `{ ok: true }`
   - Test: missing email returns 400
   - Test: always returns 200 even if Supabase returns error (no user enumeration)

2. **reset-password route**:
   - Test: valid password with active session returns 200 with `{ ok: true }`
   - Test: password too short (< 8 chars) returns 400
   - Test: missing newPassword returns 400

3. **magic-link route**:
   - Test: valid email returns 200 with `{ ok: true }`
   - Test: missing email returns 400
   - Test: always returns 200 even if Supabase returns error (no user enumeration)

Mock pattern:
```typescript
vi.mock('@/lib/supabase/server', () => ({
  createSupabaseServerClient: vi.fn(),
}));
```

Create mock Supabase client that returns success/error for `auth.resetPasswordForEmail`, `auth.updateUser`, `auth.signInWithOtp`.

Use `NextRequest` constructor to build test requests:
```typescript
const req = new Request('http://localhost:3000/api/auth/request-password-reset', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'test@example.com', redirectTo: 'http://localhost:3000/reset-password' }),
});
```

Import the POST handler directly from each route file and call it with the constructed request.
  </action>
  <verify>
Run `pnpm test -- src/lib/__tests__/auth-routes.vitest.ts` to confirm all tests pass. Run `pnpm type-check` and `pnpm lint` to confirm no regressions in documentation files.
  </verify>
  <done>All documentation files updated from Better Auth to Supabase Auth. Regression test file exists with tests for all 3 new routes. All tests pass.</done>
</task>

</tasks>

<verification>
- `pnpm type-check` passes
- `pnpm lint` passes
- `pnpm test` passes (including new auth-routes tests)
- Grep confirms no "Better Auth" in active source files (excluding historical docs)
- `.env.example` documents `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `README.md` and `SECURITY.md` reference Supabase Auth
</verification>

<success_criteria>
All stale Better Auth references replaced in active source/config/doc files. Regression tests for the 3 new auth routes pass. `pnpm type-check && pnpm lint && pnpm test` all green.
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-core/03-03-SUMMARY.md`
</output>
