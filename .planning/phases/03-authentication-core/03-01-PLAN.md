---
phase: 03-authentication-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/03-authentication-core/03-01-SUMMARY.md
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-07, AUTH-08]

must_haves:
  truths:
    - "Email/password signup flow exists and calls supabase.auth.signUp"
    - "OAuth login flow exists for Google and GitHub providers"
    - "Session persists via Supabase cookies with automatic token refresh"
    - "Sign-out clears session and redirects to home"
    - "Protected routes redirect unauthenticated users to /login"
    - "Proxy handles session refresh, CSRF, rate limiting for auth endpoints"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Server-side session management"
      exports: ["getSession", "requireAuth", "requireAdmin"]
    - path: "src/lib/auth-client.ts"
      provides: "Client-side auth wrappers"
      exports: ["signIn", "signUp", "signOut", "signInWithOAuth", "onAuthStateChange", "getUser"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client factory"
      exports: ["createSupabaseServerClient"]
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client factory"
      exports: ["createSupabaseBrowserClient"]
    - path: "src/lib/supabase/middleware.ts"
      provides: "Session refresh for proxy"
      exports: ["refreshSession"]
    - path: "proxy.ts"
      provides: "Request interception: session refresh, CSRF, rate limiting, protected redirects"
    - path: "app/api/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
    - path: "app/(auth)/login/login-form.tsx"
      provides: "Login form with email/password + OAuth + magic link"
    - path: "app/(auth)/signup/signup-form.tsx"
      provides: "Signup form with name + email + password"
  key_links:
    - from: "src/lib/auth-client.ts"
      to: "src/lib/supabase/client.ts"
      via: "createSupabaseBrowserClient import"
      pattern: "createSupabaseBrowserClient"
    - from: "src/lib/auth.ts"
      to: "src/lib/supabase/server.ts"
      via: "createSupabaseServerClient import"
      pattern: "createSupabaseServerClient"
    - from: "proxy.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "refreshSession import"
      pattern: "refreshSession"
    - from: "app/(auth)/login/login-form.tsx"
      to: "src/lib/auth-client.ts"
      via: "signIn, signInWithOAuth imports"
      pattern: "signIn|signInWithOAuth"
---

<objective>
Verify that AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-07, AUTH-08 are fully implemented by the existing Supabase Auth integration. This is a brownfield verification plan -- no code changes expected.

Purpose: Confirm the existing auth implementation satisfies 6 of 8 requirements before addressing the 2 partially-implemented ones (AUTH-05, AUTH-06) in Plan 02.
Output: 03-01-SUMMARY.md documenting verification results for each requirement.
</objective>

<execution_context>
@/Users/mneves/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mneves/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-core/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify auth module structure and session management</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/client.ts
    src/lib/supabase/middleware.ts
    app/api/auth/callback/route.ts
  </files>
  <action>
Read and verify the following files exist and contain the expected implementations:

1. **src/lib/auth.ts** -- Must export `getSession()`, `requireAuth()`, `requireAdmin()`. Verify `getSession` calls `supabase.auth.getUser()` via `createSupabaseServerClient()`. Verify the `Session` type has `user.{id, email, name, role, image}`.

2. **src/lib/auth-client.ts** -- Must export `signIn`, `signUp`, `signOut`, `signInWithOAuth`, `onAuthStateChange`, `getUser`. Verify these are thin wrappers around `supabase.auth.*` methods. Verify `signUp` passes `name`/`full_name` in `options.data`.

3. **src/lib/supabase/server.ts** -- Must export `createSupabaseServerClient()` that uses `@supabase/ssr` `createServerClient` with cookie-based auth.

4. **src/lib/supabase/client.ts** -- Must export `createSupabaseBrowserClient()`.

5. **src/lib/supabase/middleware.ts** -- Must export `refreshSession()` used by proxy.ts.

6. **app/api/auth/callback/route.ts** -- Must export `GET` handler that calls `exchangeCodeForSession(code)` and redirects to `/dashboard` (or `next` param).

For each file, verify the key exports exist and the implementation follows the Supabase SSR pattern (cookie-based, no custom JWT).

Record verification results per requirement:
- AUTH-01 (signup): `signUp()` in auth-client.ts calls `supabase.auth.signUp()` with email+password+metadata
- AUTH-02 (OAuth): `signInWithOAuth()` supports 'google'|'github', callback route handles code exchange
- AUTH-03 (session persistence): Supabase SDK manages `sb-*-auth-token` cookies, proxy calls `refreshSession()`
- AUTH-04 (logout): `signOut()` calls `supabase.auth.signOut()`
  </action>
  <verify>
All 6 files exist and contain the expected exports. Run `pnpm type-check` to confirm type safety.
  </verify>
  <done>AUTH-01, AUTH-02, AUTH-03, AUTH-04 verified as implemented with specific file/function evidence.</done>
</task>

<task type="auto">
  <name>Task 2: Verify protected route enforcement and proxy auth checks</name>
  <files>
    proxy.ts
    app/(protected)/dashboard/layout.tsx
    app/(protected)/admin/layout.tsx
    app/(protected)/planner/layout.tsx
    src/lib/security/rate-limit.ts
    src/lib/security/redirect.ts
    src/lib/auth/ui-errors.ts
    src/lib/auth/error-utils.ts
  </files>
  <action>
Read and verify:

1. **proxy.ts** -- Confirm dual-layer auth enforcement:
   - `PROTECTED_PAGE_PREFIXES` includes `/dashboard`, `/admin`, `/planner`
   - `hasSupabaseSessionCookie()` checks for `sb-*-auth-token` pattern
   - Redirects to `/login?callbackUrl=...` when no session cookie on protected pages
   - Rate limiting: 30 req / 10 min / IP for POST to `/api/auth`
   - CSRF: Fetch Metadata + origin check for state-changing methods
   - CSP nonce generation for protected pages

2. **Protected layouts** -- Each must call `getSession()` and redirect if null:
   - `app/(protected)/dashboard/layout.tsx`
   - `app/(protected)/admin/layout.tsx` (also checks admin role)
   - `app/(protected)/planner/layout.tsx`

3. **Supporting modules** -- Verify existence and purpose:
   - `src/lib/security/rate-limit.ts` -- in-memory rate limiter
   - `src/lib/security/redirect.ts` -- `normalizeCallbackUrl` for open redirect prevention
   - `src/lib/auth/ui-errors.ts` -- `mapSignInError`, `mapSignUpError` error code mapping
   - `src/lib/auth/error-utils.ts` -- `parseBodyFieldErrors` for field-level error parsing

Record verification results:
- AUTH-07 (protected redirects): proxy.ts redirects unauthenticated to /login, layouts validate session server-side
- AUTH-08 (middleware auth checks): proxy.ts handles session refresh, CSRF, rate limiting, protected page redirect, CSP
  </action>
  <verify>
All layout files exist with `getSession()` calls. proxy.ts contains rate limiting, CSRF, session refresh, and protected route redirect logic. Run `pnpm type-check` to confirm.
  </verify>
  <done>AUTH-07, AUTH-08 verified as implemented. All 6 requirements (AUTH-01 through AUTH-04, AUTH-07, AUTH-08) confirmed with specific code evidence.</done>
</task>

<task type="auto">
  <name>Task 3: Write verification SUMMARY documenting existing auth implementation</name>
  <files>.planning/phases/03-authentication-core/03-01-SUMMARY.md</files>
  <action>
Create the 03-01-SUMMARY.md using the standard summary template. Document:

1. **Requirement verification table** -- For each of AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-07, AUTH-08:
   - Requirement ID and description
   - Status: VERIFIED
   - Evidence: specific file paths, function names, and patterns found

2. **Architecture documentation** -- Describe the actual auth architecture:
   - Supabase Auth (not Better Auth as roadmap planned)
   - Dual-layer enforcement (proxy + layout)
   - Cookie pattern (`sb-<project-ref>-auth-token`)
   - Three Supabase client factories (browser, server, middleware)
   - Client auth module pattern (`auth-client.ts` wraps `supabase.auth.*`)

3. **Deviations from roadmap** -- Note:
   - Roadmap says "Better Auth" but implementation uses Supabase Auth
   - This is intentional (migration during v3 planner work)
   - Next.js 16 uses `proxy.ts` not `middleware.ts`

4. **Known gaps** (to be addressed in Plans 02 and 03):
   - AUTH-05 partially implemented (API route missing)
   - AUTH-06 partially implemented (API route missing)
   - Stale Better Auth references in multiple files
   - SEC-1: E2E bypass lacks production guard

5. **Key files reference table** mapping each auth file to its purpose.
  </action>
  <verify>
File `.planning/phases/03-authentication-core/03-01-SUMMARY.md` exists and contains verification results for all 6 requirements.
  </verify>
  <done>SUMMARY documents verification of AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-07, AUTH-08 with evidence. Known gaps cataloged for Plans 02-03.</done>
</task>

</tasks>

<verification>
- All 6 auth source files exist with expected exports
- `pnpm type-check` passes (auth types are sound)
- 03-01-SUMMARY.md documents each requirement with evidence
- No code changes made (verification-only plan)
</verification>

<success_criteria>
AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-07, AUTH-08 verified as IMPLEMENTED with specific file/function evidence documented in 03-01-SUMMARY.md. Remaining gaps (AUTH-05, AUTH-06, stale references, SEC-1) cataloged for subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-core/03-01-SUMMARY.md`
</output>
