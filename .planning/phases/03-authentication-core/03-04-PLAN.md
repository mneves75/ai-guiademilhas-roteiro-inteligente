---
phase: 03-authentication-core
plan: 04
type: execute
wave: 3
depends_on: [03-01, 03-02, 03-03]
files_modified:
  - .planning/phases/03-authentication-core/03-VERIFICATION.md
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, AUTH-06, AUTH-07, AUTH-08]

must_haves:
  truths:
    - "All 8 AUTH-* requirements are verified as implemented"
    - "Type-check, lint, and all tests pass"
    - "No stale Better Auth references remain in active source files"
    - "3 new API routes compile and are tested"
    - "E2E bypass is hardened with production guard"
  artifacts:
    - path: ".planning/phases/03-authentication-core/03-VERIFICATION.md"
      provides: "Phase 3 verification report"
      contains: "AUTH-01"
  key_links:
    - from: ".planning/phases/03-authentication-core/03-VERIFICATION.md"
      to: "app/api/auth/request-password-reset/route.ts"
      via: "verification of AUTH-05"
      pattern: "AUTH-05"
    - from: ".planning/phases/03-authentication-core/03-VERIFICATION.md"
      to: "app/api/auth/sign-in/magic-link/route.ts"
      via: "verification of AUTH-06"
      pattern: "AUTH-06"
---

<objective>
Run comprehensive verification across all 8 AUTH-* requirements. Confirm the complete auth system works: existing implementation (Plans 01), new routes (Plan 02), cleanup (Plan 03).

Purpose: Final quality gate before marking Phase 3 complete. Catches any integration issues between new routes and existing code.
Output: 03-VERIFICATION.md with pass/fail for each requirement.
</objective>

<execution_context>
@/Users/mneves/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mneves/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-core/03-RESEARCH.md
@.planning/phases/03-authentication-core/03-01-SUMMARY.md
@.planning/phases/03-authentication-core/03-02-SUMMARY.md
@.planning/phases/03-authentication-core/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full verification suite and confirm all 8 requirements</name>
  <files>.planning/phases/03-authentication-core/03-VERIFICATION.md</files>
  <action>
Execute the following verification steps and document results:

**Step 1: Build and type-check**
```bash
pnpm type-check
pnpm lint
pnpm build
```
All must pass with 0 errors.

**Step 2: Run all tests**
```bash
pnpm test
```
All tests must pass, including the new `auth-routes.vitest.ts`.

**Step 3: Verify AUTH requirement files exist**

For each requirement, confirm the implementing files exist and contain expected exports:

| Requirement | Files | Check |
|-------------|-------|-------|
| AUTH-01 | `src/lib/auth-client.ts` exports `signUp`, `app/(auth)/signup/signup-form.tsx` exists | Signup form + client function |
| AUTH-02 | `src/lib/auth-client.ts` exports `signInWithOAuth`, `app/api/auth/callback/route.ts` exports `GET` | OAuth + callback |
| AUTH-03 | `src/lib/supabase/middleware.ts` exports `refreshSession`, `proxy.ts` calls it | Session refresh |
| AUTH-04 | `src/lib/auth-client.ts` exports `signOut` | Logout |
| AUTH-05 | `app/api/auth/request-password-reset/route.ts` exports `POST`, `app/api/auth/reset-password/route.ts` exports `POST` | Both routes exist |
| AUTH-06 | `app/api/auth/sign-in/magic-link/route.ts` exports `POST` | Route exists |
| AUTH-07 | `proxy.ts` has `PROTECTED_PAGE_PREFIXES`, protected layouts call `getSession()` | Dual-layer enforcement |
| AUTH-08 | `proxy.ts` has rate limiting, CSRF, session refresh, CSP | Full middleware stack |

**Step 4: Verify stale reference cleanup**

Run grep for "Better Auth" across active source files (excluding `.planning/`, `CHANGELOG.md`, `progress.md`, `LEARN_CODEBASE.md`, `docs/REVISAO_GERAL`, `docs/solucao-elegante`, `docs/seo-estrategia`, `relatorio_seguranca`, `.env.local*`). Should return 0 matches.

Confirm `.env.example` contains `NEXT_PUBLIC_SUPABASE_URL` and does NOT contain `BETTER_AUTH_SECRET`.

**Step 5: Verify SEC-1 hardening**

Confirm `src/lib/auth.ts` contains `process.env.NODE_ENV === 'production'` guard in `getPlaywrightE2ESession()`.
Confirm `app/api/e2e/auth/bootstrap/route.ts` contains `process.env.NODE_ENV === 'production'` guard.

**Step 6: Write 03-VERIFICATION.md**

Create verification report with:
1. Summary table: all 8 AUTH-* requirements with PASS/FAIL status
2. Build verification results (type-check, lint, build, test counts)
3. Stale reference audit results
4. SEC-1 hardening confirmation
5. Phase readiness assessment (ready for Phase 4 or blockers)
6. Open questions status (from research):
   - App-level users table sync: document current state
   - Admin role assignment: document how it works
   - Email delivery: document whether Supabase or Resend handles auth emails

Format the verification as a structured report suitable for phase sign-off.
  </action>
  <verify>
File `.planning/phases/03-authentication-core/03-VERIFICATION.md` exists with all 8 requirements documented. `pnpm type-check && pnpm lint && pnpm test` all pass.
  </verify>
  <done>All 8 AUTH-* requirements verified. Build, type-check, lint, and tests pass. Stale references cleaned. SEC-1 hardened. Phase 3 ready for completion.</done>
</task>

</tasks>

<verification>
- 03-VERIFICATION.md exists with structured pass/fail for all 8 AUTH-* requirements
- `pnpm type-check` passes
- `pnpm lint` passes
- `pnpm build` passes
- `pnpm test` passes (all tests including new auth-routes tests)
- No "Better Auth" in active source files
- SEC-1 production guards confirmed
</verification>

<success_criteria>
Phase 3 verification complete. All 8 AUTH-* requirements pass. Zero build/lint/test failures. Phase is ready for sign-off and progression to Phase 4.
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-core/03-04-SUMMARY.md`
</output>
